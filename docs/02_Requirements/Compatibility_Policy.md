---
date: 2026-02-26
title: CSV Compatibility & Migration Policy
version: Macro_v1.0.0
---

# CSV互換ポリシー／マイグレーション方針（自動変換あり）

## 1. 目的

本ドキュメントは、CSVスキーマのメジャー差分（例：CSV_v1 →
CSV_v2）に対して、
**Import時に自動変換（マイグレーション）を行う**ための厳密な互換ポリシーと実施ルールを定義する。

-   「過去にExportしたCSVを、将来バージョンでも読める」ことを保証する
-   互換性を保証する範囲・失敗条件・変換規約を明確化する

> 本方針は `docs/06_Persistence/Version_Mapping_Spec.md`
> の互換性ポリシーを **上書き（強化）**する。

------------------------------------------------------------------------

## 2. 対象範囲

-   対象：CSVスキーマメジャー差分（`CSV_v1.x` → `CSV_v2.x` など）
-   対象外：将来実装予定機能のCSV列（本プロジェクト方針に従い、取り扱わない）
-   Export：常に最新スキーマで出力（旧スキーマ出力はしない）

------------------------------------------------------------------------

## 3. 基本方針（正式）

### 3.1 互換保証

-   **Importは「最新スキーマへの自動変換」を内蔵**し、次を保証する：
    -   `CSV_vN.*` を `CSV_v(N+1).*` に変換できる（段階的変換）
    -   過去スキーマでもユーザーが再利用できる

### 3.2 変換方式：段階的マイグレーション（必須）

-   `CSV_v1` を直接 `CSV_v3`
    に変換するのではなく、**必ず段階的に変換する**
    -   例：`v1 → v2 → v3`
-   各ステップは「入力ヘッダが完全にvNである」ことを前提とし、結果は「完全にvN+1」になることを保証する

> 理由：スキーマ差分の複雑化を防ぎ、変換コードと仕様の保守性を確保するため。

------------------------------------------------------------------------

## 4. スキーマ識別（正式）

### 4.1 識別優先順位

1.  **メタ行方式（推奨：v2で導入）**
    -   CSV先頭行に `#SchemaVersion=CSV_v2.0`
        のようなコメントメタ行を許容する
    -   メタ行がある場合はそれを採用する
2.  **ヘッダ一致方式（v1.0.0方式）**
    -   既知のヘッダ完全一致によりスキーマを判定する

### 4.2 メタ行仕様（v2以降の正式仕様）

-   先頭行が `#` で始まる行は **メタ行** として扱う
-   `#SchemaVersion=CSV_vA.B` を1行目に出力する（Export側はv2から必須）
-   メタ行は複数行を許容（将来拡張）するが、Importは未知キーを無視してよい

例：

    #SchemaVersion=CSV_v2.0
    #ExportedBy=MacroTool
    #ExportedAt=2026-02-26T10:00:00+09:00
    Order,Action,...

------------------------------------------------------------------------

## 5. 変換ルール（厳密）

### 5.1 列追加（vN → vN+1）

-   追加列は「**既定値（Default）**」で補完する
-   Defaultはスキーマ仕様書に必ず明記する

### 5.2 列削除

-   削除対象列は **破棄**する
-   破棄により情報損失がある場合は、以下のいずれかを必須とする：
    -   代替列への移送（rename / merge）
    -   `Comment` への退避（ユーザーが目視確認できる）
    -   もしくは Importエラー（移送不能な場合）

### 5.3 列名変更（rename）

-   `旧列名` → `新列名` に **値を移送**する
-   旧列名は出力しない（結果スキーマに存在しないため）

### 5.4 列の意味変更（semantic change）

-   変換関数（明示的ルール）を仕様書に必ず定義する
-   変換できない値が混入している場合は Importエラーとする

### 5.5 enum値の変更（値追加/値名変更）

-   旧値が新値に写像できる場合：写像規則を定義する（例：`Centered`→`Center`）
-   写像できない場合：Importエラー
-   "未知enum値"は黙って丸めない（事故防止のため）

------------------------------------------------------------------------

## 6. エラー・警告ポリシー（正式）

### 6.1 Importエラー（即失敗）条件

-   スキーマ判定不能（メタ行なし＋ヘッダ不一致）
-   必須列欠落（当該スキーマの必須列）
-   型変換不可（数値/真偽/色コード/enum等）
-   GoTo参照不整合（最終的に解決できない）
-   マイグレーション規則が存在しないバージョン（例：CSV_v5が来たが v4→v5
    が未実装）

### 6.2 警告（継続）条件

-   仕様上「無視してよい」と定義された未知メタキー
-   スキーマ上は許容だが値が冗長（例：Area以外のX1..Y2が入っている）
-   Labelの重複（自動採番で解決できる）

> 警告はユーザーに通知可能とする（UIログなど）。v1.0.0では通知が難しければ内部ログでもよい。

------------------------------------------------------------------------

## 7. v1 → v2 自動変換の実装原則（本方針の最重要点）

### 7.1 変換後の保証

-   変換結果は **必ず v2 の固定ヘッダ**（およびv2の制約）に一致する
-   変換は「行単位」ではなく「ファイル全体」を対象とする
    -   例：ラベル参照解決のため、全行のLabel/GoToを解決してから確定する

### 7.2 v1 → v2 の差分は "1つの仕様書" として管理する

-   v1ヘッダ
-   v2ヘッダ
-   追加列のDefault
-   rename/merge規則
-   変換不能条件

を **必ず1ファイルにまとめて**管理する（後述）。

------------------------------------------------------------------------

## 8. 仕様書配置（推奨）

    docs/06_Persistence/Compatibility_Policy.md
    docs/06_Persistence/Migrations/
      ├─ CSV_v1_to_v2.md
      ├─ CSV_v2_to_v3.md
      └─ ...

-   `Compatibility_Policy.md`：全体方針（本書）
-   `Migrations/CSV_vN_to_vN+1.md`：個別マイグレーション仕様（差分定義）

------------------------------------------------------------------------

## 9. Version_Mapping_Spec.md への反映（運用）

-   `Version_Mapping_Spec.md`
    の「Aが異なる場合は互換保証しない」は、今後以下に置き換える：
    -   **Aが異なっても、規定された移行経路（vN→vN+1）が存在する限りImport互換を保証する**
    -   規定経路がない場合は互換保証しない（Importエラー）

------------------------------------------------------------------------

以上
